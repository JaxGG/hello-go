name: Deploy to Local Kubernetes

on:
  # 自动触发：当 CI/CD Pipeline 的 build-and-push job 成功完成后
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
      - master
  # 手动触发：保留手动触发功能
  workflow_dispatch:
    inputs:
      image_tag:
        description: '镜像标签 (例如: latest, main-abc123)，留空则使用 latest'
        required: false
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    # 只在 build-and-push job 成功时运行
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发：使用输入的标签或默认 latest
            IMAGE_TAG_INPUT="${{ inputs.image_tag }}"
            if [ -z "$IMAGE_TAG_INPUT" ]; then
              IMAGE_TAG_INPUT="latest"
            fi
            echo "tag=${IMAGE_TAG_INPUT}" >> $GITHUB_OUTPUT
            echo "commit=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          else
            # 自动触发：使用 latest 标签（对应 build-and-push 构建的 latest 标签）
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger local deployment via webhook
        run: |
          # 通过内网穿透的 webhook URL 触发本地部署
          WEBHOOK_URL="${WEBHOOK_URL}"
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "Error: WEBHOOK_URL secret is not set"
            exit 1
          fi
          
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}"
          
          echo "准备部署镜像: ${IMAGE_TAG}"
          echo "Webhook URL: ${WEBHOOK_URL}"
          echo "Commit: ${{ steps.image-tag.outputs.commit }}"
          echo "Ref: ${{ steps.image-tag.outputs.ref }}"
          
          # 调用本地 webhook 服务器
          response=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: deployment" \
            -d "{
              \"image\": \"${IMAGE_TAG}\",
              \"tag\": \"${{ steps.image-tag.outputs.tag }}\",
              \"ref\": \"${{ steps.image-tag.outputs.ref }}\",
              \"commit\": \"${{ steps.image-tag.outputs.commit }}\"
            }")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Webhook response (HTTP $http_code):"
          echo "$body"
          
          if [ "$http_code" != "200" ]; then
            echo "Error: Webhook call failed with HTTP $http_code"
            exit 1
          fi
          
          echo "Deployment triggered successfully"
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

